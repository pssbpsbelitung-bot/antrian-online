<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Antrian Kunjungan PST BPS Belitung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background:#f8fafc;
  padding:24px;
  color:#111827;
}
h2{margin-bottom:6px}
.card{
  background:#fff;
  border-radius:18px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 10px 24px rgba(0,0,0,.05);
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.stat{border-left:6px solid #1d4ed8}
.stat.orange{border-color:#f97316}
.stat.green{border-color:#16a34a}
.stat h3{font-size:28px;margin:4px 0}

button{
  border:none;
  border-radius:10px;
  padding:10px 16px;
  font-size:14px;
  cursor:pointer;
  color:#fff;
}
.btn-green{background:#16a34a}
.btn-blue{background:#1d4ed8}
.btn-red{background:#ef4444}
.btn-small{padding:6px 12px;font-size:12px}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
}
th{
  font-size:12px;
  text-transform:uppercase;
  color:#6b7280;
  text-align:left;
}

.badge{
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
}
.wait{background:#fef3c7;color:#92400e}
.done{background:#dcfce7;color:#166534}

footer{
  text-align:center;
  font-size:12px;
  color:#6b7280;
  margin-top:20px;
}
</style>
</head>

<body>

<h2>üéüÔ∏è Antrian Kunjungan PST</h2>
<p style="color:#6b7280;margin-bottom:20px">
Sistem Antrian & Statistik Pengunjung PST BPS Kabupaten Belitung
</p>

<!-- STAT -->
<div class="grid">
  <div class="card stat">
    <small>Total Hari Ini</small>
    <h3 id="total">0</h3>
  </div>
  <div class="card stat orange">
    <small>Menunggu</small>
    <h3 id="waiting">0</h3>
  </div>
  <div class="card stat green">
    <small>Selesai</small>
    <h3 id="done">0</h3>
  </div>
</div>

<!-- AMBIL ANTRIAN -->
<div class="card">
  <h3>Ambil Nomor Antrian</h3>
  <button class="btn-green" onclick="ambilAntrian()">üé´ Ambil & Cetak Tiket</button>
</div>

<!-- STATISTIK -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>üìä Statistik Pengunjung Bulanan</h3>
    <button class="btn-blue" onclick="toggleStat()">Tampilkan</button>
  </div>

  <div id="statistikBox" style="display:none;margin-top:16px">
    <div style="display:flex;gap:10px;margin-bottom:12px">
      <input type="month" id="filterBulan">
      <button class="btn-green" onclick="applyFilterBulanan()">Terapkan</button>
    </div>
    <canvas id="chartPengunjung" height="110"></canvas>
  </div>
</div>

<!-- RIWAYAT -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <h3>üìú Riwayat Kunjungan</h3>
    <div>
      <button class="btn-red" onclick="resetTampilan()">üîÑ Reset Tampilan</button>
      <button class="btn-red" onclick="resetDatabase()">üóëÔ∏è Reset Database</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>No</th>
        <th>Tanggal</th>
        <th>Jam</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="log"></tbody>
  </table>
</div>

<footer>¬© PST BPS Kabupaten Belitung</footer>

<script>
let data = JSON.parse(localStorage.getItem("antrianPST")) || [];
let startViewDate = localStorage.getItem("startViewDate");
const today = new Date().toLocaleDateString("id-ID");

/* === AMBIL ANTRIAN (RESET NOMOR HARIAN) === */
function ambilAntrian(){
  const nomorHariIni = data.filter(d => d.tgl === today).length + 1;

  const tiket = {
    no: nomorHariIni,
    tgl: today,
    jam: new Date().toLocaleTimeString("id-ID"),
    status: "Menunggu"
  };

  data.push(tiket);
  localStorage.setItem("antrianPST", JSON.stringify(data));
  render();
  cetakTiket(tiket);
}

/* === SELESAI === */
function selesaikan(i){
  if(!confirm("Tandai antrian sebagai SELESAI?")) return;
  data[i].status = "Selesai";
  localStorage.setItem("antrianPST", JSON.stringify(data));
  render();
}

/* === RESET === */
function resetTampilan(){
  if(!confirm("Reset tampilan? Data lama tetap disimpan.")) return;
  startViewDate = today;
  localStorage.setItem("startViewDate", startViewDate);
  render();
}

function resetDatabase(){
  if(!confirm("HAPUS SEMUA DATA antrian?")) return;
  localStorage.clear();
  data = [];
  if(window.chart) window.chart.destroy();
  render();
}

/* === RENDER TABLE === */
function render(){
  const log = document.getElementById("log");
  log.innerHTML = "";

  let wait=0, done=0;

  data.forEach((d,i)=>{
    if(startViewDate){
      const t = new Date(d.tgl.split("/").reverse().join("-"));
      const s = new Date(startViewDate.split("/").reverse().join("-"));
      if(t < s) return;
    }

    if(d.status==="Menunggu") wait++;
    if(d.status==="Selesai") done++;

    log.innerHTML += `
    <tr>
      <td>${d.no}</td>
      <td>${d.tgl}</td>
      <td>${d.jam}</td>
      <td><span class="badge ${d.status==="Menunggu"?"wait":"done"}">${d.status}</span></td>
      <td>${d.status==="Menunggu"
        ? `<button class="btn-small btn-green" onclick="selesaikan(${i})">‚úî Selesai</button>`
        : "-"}</td>
    </tr>`;
  });

  document.getElementById("total").innerText =
    data.filter(d=>d.tgl===today).length;
  document.getElementById("waiting").innerText = wait;
  document.getElementById("done").innerText = done;
}

/* === STATISTIK BULANAN === */
function toggleStat(){
  const box = document.getElementById("statistikBox");
  const btn = event.target;
  box.style.display = box.style.display==="none" ? "block" : "none";
  btn.innerText = box.style.display==="block" ? "Sembunyikan" : "Tampilkan";
}

function applyFilterBulanan(){
  const val = filterBulan.value;
  if(!val){ alert("Pilih bulan dan tahun"); return; }

  const [year, month] = val.split("-").map(Number);
  const days = new Date(year, month, 0).getDate();

  const perHari = {};
  for(let d=1; d<=days; d++) perHari[d]=0;

  data.forEach(it=>{
    const [dd,mm,yy] = it.tgl.split("/").map(Number);
    if(mm===month && yy===year) perHari[dd]++;
  });

  renderChartBulanan(perHari, month, year);
}

function renderChartBulanan(perHari, month, year){
  if(window.chart) window.chart.destroy();

  window.chart = new Chart(chartPengunjung,{
    type:"bar",
    data:{
      labels:Object.keys(perHari),
      datasets:[{
        data:Object.values(perHari),
        backgroundColor:"#1d4ed8"
      }]
    },
    options:{
      scales:{
        x:{title:{display:true,text:"Tanggal"}},
        y:{beginAtZero:true,title:{display:true,text:"Jumlah Pengunjung"},ticks:{precision:0}}
      },
      plugins:{legend:{display:false}}
    }
  });
}

/* === CETAK TIKET MINI 58mm === */
function cetakTiket(t){
  const w = window.open("","","width=240,height=400");
  w.document.write(`
  <style>
    @page{margin:0;size:58mm auto}
    body{margin:0;padding:8px;font-family:Arial;text-align:center;font-size:12px}
    h1{font-size:48px;margin:6px 0}
    hr{border:none;border-top:1px dashed #000;margin:6px 0}
  </style>
  <body onload="window.print()">
    <strong>PST BPS Kab. Belitung</strong>
    <div>Nomor Antrian</div>
    <h1>${t.no}</h1>
    <hr>
    <div>${t.tgl}<br>${t.jam}</div>
    <hr>
    <div>Mohon menunggu<br>Terima kasih</div>
  </body>`);
  w.document.close();
}

render();
</script>

</body>
</html>
